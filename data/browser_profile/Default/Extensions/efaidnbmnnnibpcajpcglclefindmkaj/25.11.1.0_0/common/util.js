/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{common as e}from"../sw_modules/common.js";import{util as t}from"../sw_modules/util.js";import{dcLocalStorage as o,dcSessionStorage as r}from"./local-storage.js";import{ADOBE_URL as n,demoFileURL as a,ONBOARDING_DEMO as s}from"./constant.js";import{getActiveExperimentAnalyticsArray as i}from"./experimentUtils.js";import{COI_HEADERS as c}from"../sw_modules/constant.js";import{analytics as m,events as p}from"./analytics.js";import{loggingApi as l}from"./loggingApi.js";import{floodgate as u}from"../sw_modules/floodgate.js";export function isNewUser(){if(!o.getItem("extUserState")){const e=o.getItem("viewerStorage");if(e){return+(0===(parseInt(e.usage)||0))}return-1}return 0}export async function updateExtUserState(){if(!o.getItem("extUserState")){o.setItem("extUserState","ru");const e=await chrome.tabs.query({active:!0,lastFocusedWindow:!0});chrome.runtime.sendMessage({main_op:"reRegisterUninstallUrl",tab:e[0]})}}const g="machine";export function setCookie(e,t,o={}){const r={name:e,value:t,secure:!0,sameSite:"no_restriction"};o.url&&(r.url=o.url),o.path&&(r.path=o.path),o.expiryDate&&(r.expirationDate=o.expiryDate),o.sameSite&&(r.sameSite=o.sameSite),o.secure&&(r.secure=o.secure),o.domain&&(r.domain=o.domain),chrome.cookies.set(r)}async function d(e,t=void 0){const o=new Date,r=o.getMonth(),a=o.getFullYear();let s="mmac";e===g&&(s+="_machine"),t&&(s+=`_${t}`);let i=null;try{i=await chrome.cookies.get({url:n,name:s});const e=!i||function(e,t,o){const r=new Date(e),n=r.getMonth(),a=r.getFullYear();return o>a||o===a&&t>n}(i.value,r,a);return!e}catch(e){return!1}}function h(t){const o=e.getAcroIpmURL(),r=new URL(o);return t.pingType===g&&(r.pathname+="/machine"),t.appPath?r.pathname+=`/${encodeURIComponent(t.appPath)}`:r.pathname+="/overall",Object.keys(t.schema).forEach(e=>{const o=t.schema[e];r.pathname+=o?`/${encodeURIComponent(o)}`:"/unspecified"}),r.pathname+="/mmac.html",r.toString()}async function f(e,t,o=void 0){try{const r=await fetch(e);if(200===r?.status){let e="mmac";t===g&&(e+="_machine"),o&&(e+=`_${o}`);const r=new Date,a=Math.floor(Date.now()/1e3)+2678400;setCookie(e,r.toISOString(),{url:n,expiryDate:a,path:"/",domain:".adobe.com"})}}catch(e){console.error(e)}}async function w(e){if(async function(e){e&&!await d(g)&&f(h({...e,appPath:void 0,pingType:g}),g)}(e),function(e){return!!e&&!(!e.appPath||"string"!=typeof e.appPath||""===e.appPath.trim())}(e)&&!await d(g,e.appPath)){f(h({...e,pingType:g}),g,e.appPath)}}export function sendPingEventHandler(){let e="chrome-extension";t.isEdge()&&(e="edge-extension");const r=o.getItem("appLocale");let n=o.getItem("viewer-locale");n||(n=o.getItem("locale")),w({appPath:e,schema:{appIdentifier:"dc-acrobat-extension",appVersion:chrome.runtime.getManifest().version,appReferrer:o.getItem("installSource"),userType:"unknown",subscriptionType:"unknown",locale:r||n}})}export const isEdgeBrowser=()=>t.isEdge();export const isChromeViewerOpened=e=>{if(!e)return!1;const t=`chrome-extension://${chrome.runtime.id}`;return e.startsWith(`${t}/http`)||e.startsWith(`${t}/https`)||e.startsWith(`${t}/viewer.html`)||e.startsWith(`${t}/file`)};export const isDemoMode=(e,t)=>{if(!e||!t)return!1;const r=new URL(t),n=r.origin+r.pathname,i=o.getItem("od"),c="en"===(o.getItem("appLocale")||o.getItem("viewer-locale")||o.getItem("locale")).toLowerCase().split("-")[0],{name:m,source:p}=((e="")=>{try{if(!e)return{};const t=e.length%4;return JSON.parse(decodeURIComponent(atob(e.replace(/-/g,"+").replace(/_/g,"/").padEnd(e.length+(0===t?0:4-t),"="))))}catch(e){log("decodeBlobUrl failed",e)}})(e);return!(m!==s||"cdn"!==p||n!==a||!i||!c)};export const getGenAIServiceVariant=()=>{const t=o.getItem("cluster");return t||(e.isAdobeInternalUser()?"beta":"release")};export const verCmp=(e,t)=>e.localeCompare(t,void 0,{numeric:!0,sensitivity:"base"});export const isMigrationCompleted=()=>"true"===o.getItem("migrationOfSyncToAsyncStorage");export const isMigrationCleanupCompleted=()=>"true"===o.getItem("migrationOfSyncToAsyncStorageCleanup");export const getSearchParams=e=>{try{return new URL(e).searchParams}catch{return new URLSearchParams}};export const sendCoiEnabledEvent=(e,t)=>{const o=r.getItem(c)||{},n=o[e]||{},a=n["cross-origin-embedder-policy"];a&&!n.eventSent&&(m.event(p.COEP_STATUS_EVENT,{...t,dvDisableSessionCount:a||"none"}),n.eventSent=!0,o[e]=n,r.setItem(c,o),l.info({message:p.COEP_STATUS_EVENT,...t,coepHeaderValue:a}))};export function removeCoiTab(e){const t=r.getItem(c)||{};t[e]&&(delete t[e],r.setItem(c,t))}export function trackCoiHeaders(e){if("main_frame"===e.type&&e.responseHeaders){const t=e.responseHeaders.filter?.(e=>"cross-origin-embedder-policy"===e.name.toLowerCase()),o=e.responseHeaders.filter?.(e=>"cross-origin-opener-policy"===e.name.toLowerCase()),n=r.getItem(c)||{},a={"cross-origin-embedder-policy":null,"cross-origin-opener-policy":null};if(1===t?.length){const e=t[0].value.toLowerCase().trim(),o=["require-corp","credentialless"].filter(t=>e.includes(t))[0];o&&(a["cross-origin-embedder-policy"]=o)}if(o?.length>0){const e=o[0].value.toLowerCase().trim(),t=["same-origin","same-origin-allow-popups","noopener-allow-popups"].filter(t=>e.includes(t))[0];t&&(a["cross-origin-opener-policy"]=t)}a["cross-origin-embedder-policy"]||a["cross-origin-opener-policy"]?(n[e.tabId]=a,r.setItem(c,n)):removeCoiTab(e.tabId)}}export function getLocalFilePromptDimensions(e){const t=Math.min(Math.round(.8*e.height),900),o=Math.min(Math.round(.9*e.width),1550);return{height:t,width:o,top:Math.round(.5*(e.height-t)+e.top),left:Math.round(.5*(e.width-o)+e.left)}}export const isLocalFileUrl=e=>e.startsWith("file:///")&&(e.endsWith(".pdf")||e.endsWith(".PDF"));export const fetchCombinationOfLocalFilePromptCooldownConfig=async()=>{let e;try{e=await u.getFeatureMeta("dc-cv-combination-of-local-file-prompt"),e=JSON.parse(e)}catch(t){e={promptLimit:6,ignoreCoolDown:30,settingsCoolDown:14,dismissCoolDown:30}}return e};export const fetchLocalFileAccessAndSummaryCoachmarkCooldownConfig=async()=>{let e;try{e=await u.getFeatureMeta("dc-cv-local-file-access-and-summary-coachmark"),e=JSON.parse(e)}catch(t){e={promptLimit:10,ignoreCoolDown:30,settingsCoolDown:14,dismissCoolDown:30}}return e};export const safeJsonParse=(e,t)=>{try{return JSON.parse(e)}catch(e){const o=(new Error)?.stack,r=o?o.split?.(/\n/)?.[2]?.trim?.():"unknown location";return l.error({message:`Error parsing JSON at ${r}`,error:e?.message}),t}};